<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable= no">
    <title>Chat</title>
    <link rel="stylesheet" href="../css/sidebar.css">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <button class="sidebar-toggle" aria-label="Toggle Sidebar">
        <svg xmlns="http://www.w3.org/2000/svg" fill="white" width="15" height="15"  viewBox="0 0 15 15" >
            <path d="M3 6h18c.552 0 1-.448 1-1s-.448-1-1-1H3c-.552 0-1 .448-1 1s.448 1 1    1zm0 5h18c.552 0 1-.448 1-1s-.448-1-1-1H3c-.552 0-1 .448-1 1s.448 1 1 1zm0 5h18c.552 0 1-.448 1-1s-.448-1-1-1H3c-.552 0-1 .448-1 1s.448 1 1 1z"/>
        </svg>
    </button>
    <div class="sidebar">
        <h2>Chat</h2>
       <input type="search" id="searchInput" placeholder="Search or start new chat">
        <ul id="searchResult"></ul>
        <ul id="userList"></ul>
    </div>
    
    <div class="container">
      <div class="chat-header">
        <h2 id="receiverName"></h2> 
        <div style="display: flex; gap: 10px;">
        <button class="voiceCall" aria-label="Voice Call" style="background: none; border: none; padding: 8px; cursor: pointer;">
            <svg height="18" width="18" fill="white" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path d="M0 0h48v48H0z" fill="none"/>
              <path d="M13.25 21.59c2.88 5.66 7.51 10.29 13.18 13.17l4.4-4.41c.55-.55 1.34-.71 2.03-.49C35.1 30.6 37.51 31 40 31c1.11 0 2 .89 2 2v7c0 1.11-.89 2-2 2C21.22 42 6 26.78 6 8c0-1.11.9-2 2-2h7c1.11 0 2 .89 2 2 0 2.49.4 4.9 1.14 7.14.22.69.06 1.48-.49 2.03l-4.4 4.42z"/>
            </svg>
          </button>
    
          
          <button class="videoCall" aria-label="Video Call" style="background: none; border: none; padding: 8px; cursor: pointer;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="white" width="18" height="18" viewBox="0 0 576 512">
              <path d="M0 128C0 92.7 28.7 64 64 64l256 0c35.3 0 64 28.7 64 64l0 256c0 35.3-28.7 64-64 64L64 448c-35.3 0-64-28.7-64-64L0 128zM559.1 99.8c10.4 5.6 16.9 16.4 16.9 28.2l0 256c0 11.8-6.5 22.6-16.9 28.2s-23 5-32.9-1.6l-96-64L416 337.1l0-17.1 0-128 0-17.1 14.2-9.5 96-64c9.8-6.5 22.4-7.2 32.9-1.6z"/>
            </svg>
        </button>
      </div>
    </div>

        <div id="chatMessages" class="chat-box"></div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Type a message">
            <button id="sendMessageBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
                  </svg>
            </button>
        </div>
    </div>
    <script>

const sidebar = document.querySelector('.sidebar');
const toggleButton = document.querySelector('.sidebar-toggle');

function handleToggleButton() {
    if (window.innerWidth <= 480) {
        toggleButton.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });
    }
}

window.addEventListener('resize', () => {

    if (window.innerWidth <= 480) {
        handleToggleButton();
        toggleButton.style.display = 'block'; 
    } else {
        toggleButton.removeEventListener('click', () => {
            sidebar.classList.toggle('open');
        });
        toggleButton.style.display = 'none'; 
    }
});
handleToggleButton();

        let offset = 0;
        let limit = 20;

        const token = localStorage.getItem('token');
        if(!token){
            alert('You are not logged in');
            window.location.href = 'index.html';
        }
        const payload = JSON.parse(atob(token.split('.')[1]));
        const userId = payload.id;
        const senderId = userId;
        // console.log('userId:', senderId);

        document.addEventListener('DOMContentLoaded', () => {
        const voiceCallButton = document.querySelector('.voiceCall');
        const token = localStorage.getItem('token');
    
     voiceCallButton.addEventListener('click', () => {
        if (!token) {
            alert('You must be logged in to make a voice call.');
            window.location.href = 'index.html';
            return;
        }
        
        if (!receiverId) {
            alert('Please select a user to initiate a voice call.');
            return;
        }

        window.location.href = `/voiceCall.html?userId=${receiverId}`;
  });
        });

        document.addEventListener('DOMContentLoaded', () => {
        const videoCallButton = document.querySelector('.videoCall');
        const token = localStorage.getItem('token');
                  
    videoCallButton.addEventListener('click', () => {
        if (!token) {
            alert('You must be logged in to make a video call.');
            window.location.href = 'index.html';
            return;
        }
        
        if (!receiverId) {
            alert('Please select a user to initiate a video call.');
            return;
        }

        window.location.href = `/videocall.html?userId=${receiverId}`;
    });
});

        const socket = io(`https://chat-app-4dp7.onrender.com`,{
            auth: {
                token
            }
        });
        
    const userList = document.getElementById('userList');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const receiverName = document.getElementById('receiverName');
    let receiverId = null;
    const unreadMessage = {};

    function resetUserCount(userName){
        const userItem = Array.from(userList.children).find((item) => item.textContent.includes(userName));
        if(userItem){
            userItem.style.fontWeight = 'normal';
            userItem.querySelector('.unread-count').textContent = '' ;
    }
}

function clearUnreadCountBackground(userName) {
    const userItem = Array.from(userList.children).find((item) => item.textContent.includes(userName));
    if (userItem) {
        userItem.querySelector('.unread-count').style.backgroundColor = ''; 
    }
}

function resetTimestamp(userName) {
    const userItem = Array.from(userList.children).find((item) => item.textContent.includes(userName));
    if (userItem) {
        userItem.querySelector('.timestamp').textContent = ''; 
    }
}

    const searchInput =  document.getElementById('searchInput')
    const searchResult = document.getElementById('searchResult')

    searchInput.addEventListener('input',async(e) => {
        const query = e.target.value.trim();

        if(query)
    {
        try {
            const response = await fetch(`https://chat-app-4dp7.onrender.com/api/v1/user/users/${isNaN(query) ?'': query }/${isNaN(query) ? query: '' }`,
         {
            headers: {
                Authorization: `Bearer ${token}`
            }
            });
            if (!response.ok) {
                throw new Error('Error fetching search results');
            }
            const data = await response.json();
            const users = data.users;
         
            searchResult.innerHTML = ''; 
            
            if(users){
                const userItem = document.createElement('li');
                userItem.textContent = ` ${users.userName} [${users.id}]`;
                userItem.addEventListener('click',()=>{
                    receiverId = users.id;
                    receiverName.textContent = `${users.userName}`;
                    loadMessages(receiverId);
                    searchResult.innerHTML = '';
                    resetUserCount(users.userName)
                    currentReceiver = users.userName
                })
                searchResult.appendChild(userItem)
            }else{
                searchResults.innerHTML = '<li>No user found</li>';
            }
            
        } catch (error) {
            console.log("This is error",error)
            searchResult.innerHTML = 'No user found'
        }
    }
    else{
        searchResult.innerHTML = '';
    }
    })

    const users = []

    async function loadUsers() {
    try {
        const response = await fetch(`https://chat-app-4dp7.onrender.com/api/v1/all-users`, {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('Failed to fetch users');
        }

        const users = await response.json();
        userList.innerHTML = '';

        users.forEach(user => {
            const userItem = document.createElement('li');
            userItem.textContent = ` ${user.userName}`;
            userItem.classList.add('user-item');
            userItem.setAttribute('data-user-id', user.id);
            const unreadCount = document.createElement('span');
            unreadCount.classList.add('unread-count');
            unreadCount.textContent = user.unreadCount;

            const timestamp = document.createElement('span');
            timestamp.classList.add('timestamp');
            timestamp.textContent = user.lastMessageTime ? new Date(user.lastMessageTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            userItem.appendChild(timestamp)

            userItem.appendChild(unreadCount);
            userItem.appendChild(timestamp);


            userItem.addEventListener('click', () => {
                receiverId = user.id;
                receiverName.textContent = ` ${user.userName}`;
                loadMessages(receiverId);
                resetUserCount(user.userName);
                clearUnreadCountBackground(user.userName);
                // resetTimestamp(user.userName);
                
                // console.log((user.userName))
            });
            userList.appendChild(userItem);
        });
    } catch (error) {
        console.error('Error fetching users:', error);
    }
}
    loadUsers();

// const username = localStorage.getItem('senderName');

async function updateMessage(messageId,updatedContent) {
    try {
        const response = await fetch(`http://localhost:7116/api/v1/chat/update/${messageId}`,{
            method: 'PATCH',
            headers: {
                Authorization: `Bearer ${token}`,
               'Content-Type': 'application/json'
            },
            body: JSON.stringify({content: updatedContent})
        })

        const data = await respone.json();
        if(respone.ok){
            contentUpdated(messageId,updatedContent);

        }
        else{
            console.log("something wrong while updating message",data.error)
        }

        socket.emit('updateMessage', { messageId, updatedContent });

    } catch (error) {
        console.error("something wrong while updating message",error)
    }
}

function updatedMassage(messageId,updatedContent){
    const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageDiv) {
        messageDiv.textContent = updatedContent;
    }
}

async function deleteMessage(messageId) {
    // console.log(messageId);

    try {
        const response = await fetch(`https://chat-app-4dp7.onrender.com/api/v1/chat/delete/${messageId}`, {
            method: 'DELETE',
            headers: {
                Authorization: `Bearer ${token}`
            }
        });
        // console.log(response)

        if (!response.ok) {
            throw new Error('Failed to delete the message');
        }

        const result = await response.json();

        if (result.message === 'Message deleted successfully') {
            removeMessage(messageId);
            socket.emit('deleteMessage', { messageId, receiverId });
        }
    
        loadMessages(receiverId);
        
    } catch (error) {
        console.error('Error deleting message:', error);
        return alert(error.message)
       }   
    }

    socket.on('messageDeleted', ({ messageId }) => {
    console.log('Received messageDeleted event for messageId:', messageId);
    const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageDiv) {
        // messageDiv.textContent = 'This message was deleted';
        messageDiv.classList.add('deleted-message');
    }
});

    function removeMessage(messageId) {
        const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageDiv) {
        messageDiv.textContent = 'This Message was deleted';
        messageDiv.classList.add('deleted-message');
    }
}

    async function loadMessages(receiverId,offset = 0,limit = 10000) {
        try {

            const response = await fetch(`https://chat-app-4dp7.onrender.com/api/v1/chat/${senderId}/${receiverId}?offset=${offset}&limit=${limit}`,{
                method: 'GET',
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });

            const data = await response.json();
            const messages = data.messages;

            // console.log('Messages:', messages);
            // console.log("chatMessages:", chatMessages);
            
            chatMessages.innerHTML = '';

            if(messages && messages.length > 0){
                messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.setAttribute('data-message-id', message.id);
                    const messageTime = new Date(message.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });

                    messageDiv.textContent = message.senderId === senderId ? ` ${message.content}` : ` ${message.content}`;
                    messageDiv.className = message.senderId === senderId ? 'send' : 'received';

            const timeSpan = document.createElement('span');
            timeSpan.textContent = messageTime;
            timeSpan.className = 'timestamp';
            messageDiv.appendChild(timeSpan);
            
       
            // const deleteButton = document.createElement('button');
            // deleteButton.className = 'delete-button'; 
            // deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="16" height="16">
            // <path d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z"/>
            // </svg>`;
            // deleteButton.addEventListener('click', () => deleteMessage(message.id));
            // messageDiv.appendChild(deleteButton);


            const dropdownButton = document.createElement('button');
            dropdownButton.className = 'dropdown-button'; 
            dropdownButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="16" height="16">
            <path d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z"/>
            </svg>`;

            messageDiv.appendChild(dropdownButton);

            const dropdownMenu = document.createElement('ul');
            dropdownMenu.className = 'dropdown-menu';
            dropdownMenu.innerHTML = `
            <li class="update-option">Update</li>
            <li class="delete-option">Delete</li>`;

            dropdownMenu.style.display = 'none';
            messageDiv.appendChild(dropdownMenu);

            dropdownButton.addEventListener('click', (e) => {
            e.stopPropagation(); 
            const isMenuVisible = dropdownMenu.style.display === 'block';
            dropdownMenu.style.display = isMenuVisible ? 'none' : 'block';
        });

            document.addEventListener('click', (e) => {
            if (!messageDiv.contains(e.target)) {
                dropdownMenu.style.display = 'none';
                }
            });

            const updateOption = dropdownMenu.querySelector('.update-option');
            const deleteOption = dropdownMenu.querySelector('.delete-option');

            updateOption.addEventListener('click', () => {
                updateMessage(message.id);
                dropdownMenu.style.display = 'none';
            });

            deleteOption.addEventListener('click', () => {
            deleteMessage(message.id);
            dropdownMenu.style.display = 'none';
        });


        chatMessages.appendChild(messageDiv);
    });
            chatMessages.scrollTop = chatMessages.scrollHeight;
             offset += limit;
            }
            else{
                const notmessageDiv = document.createElement('div');    
                notmessageDiv.textContent = 'No messages yet';
                notmessageDiv.className = 'notmessage';
                chatMessages.appendChild(notmessageDiv);
            }

        } catch (error) {
            console.error('Error fetching messages:', error);
        }
    }

    sendMessageBtn.addEventListener('click', () => {
        // console.log('Send message clicked');
        const content = messageInput.value;
      
        if(content && receiverId){
            socket.emit('sendMessage',{
                content,
                receiverId,
                createdAt: new Date().toISOString()
            });

            const messageDiv = document.createElement('div');
            messageDiv.textContent = content;
            messageDiv.className = 'send';

            const currentTime = new Date().toLocaleTimeString([], 
        { 
            hour: '2-digit', 
            minute: '2-digit', 
            hour12: false 
        });   

            const userItem = Array.from(userList.children).find(item => item.getAttribute('data-user-id') === String(receiverId));
            if (userItem) {
                const timestamp = userItem.querySelector('.timestamp');
                if (timestamp) timestamp.textContent = currentTime;
            }

            const timeSpan = document.createElement('span');
            timeSpan.textContent = currentTime;
            timeSpan.className = 'timestamp';

            messageDiv.appendChild(timeSpan);

            chatMessages.appendChild(messageDiv);
            messageInput.value = '';

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }else{
            alert('Please select a user to chat with OR Write a message');
        }
    });


    socket.on('receiveMessage', (message) => {
        const currentTime = new Date(message.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit',hour12: false });
  
        const userItems = Array.from(userList.children)
        const userItem = userItems.find((item) => item.getAttribute('data-user-id') === String(message.senderId));

         if (message.senderId !== receiverId || message.receiverId !== senderId)   
            {   

            if(userItem){
                let unreadCount = parseInt(userItem.querySelector('.unread-count').textContent || 0);
                unreadCount++;
                userItem.querySelector('.unread-count').textContent = unreadCount;
                    
                userItem.style.fontWeight = 'bold';
                userItem.querySelector('.unread-count').style.backgroundColor = '#53c66cb2';
                const timestamp = userItem.querySelector('.timestamp');
                if (timestamp) timestamp.textContent = currentTime
                
            }
            return;
        }
            const timestamp = userItem.querySelector('.timestamp');
            if (timestamp) timestamp.textContent = currentTime;
        
    const messageDiv = document.createElement('div');

    if (message.senderId === senderId) {
        messageDiv.textContent = ` ${message.content}`;
        messageDiv.className = 'send';
    } else {
        messageDiv.textContent = `${message.content}`; 
        messageDiv.className = 'received';
    }

    const timeSpan = document.createElement('span');
    timeSpan.textContent = currentTime;
    timeSpan.className = 'timestamp';
    messageDiv.appendChild(timeSpan);


    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight; 

    if(message.senderId !== senderId){
        if(!localStorage.getItem('senderName')){
            localStorage.setItem('senderName', message.senderName);
        }
    }
});

messageInput.addEventListener('keydown', (event) => {
    if (event.key === 'Enter') {
        sendMessageBtn.click();
    }
});
    </script>
    
</body>
</html>